<policies>
    <inbound>
        <!-- Azure OpenAI Token Limit Policy -->
        <!-- Tracks token consumption across all API keys -->
        <azure-openai-token-limit 
            counter-key="@(context.Subscription.Id)" 
            tokens-per-minute="50000" 
            estimate-prompt-tokens="true" 
            remaining-tokens-variable-name="remainingTokens" 
            tokens-consumed-variable-name="tokensConsumed" 
            retry-after-variable-name="retryAfter">
            <!-- Optional: Different limits for different subscription tiers -->
            <token-limit-rule key="@(context.Subscription.Name.Contains("premium") ? "premium" : "standard")">
                <tokens-per-minute>100000</tokens-per-minute>
            </token-limit-rule>
        </azure-openai-token-limit>
        
        <!-- Emit token metrics for monitoring -->
        <set-variable name="tokenMetrics" value="@{
            return new JObject(
                new JProperty("subscriptionId", context.Subscription.Id),
                new JProperty("tokensConsumed", context.Variables.GetValueOrDefault<int>("tokensConsumed", 0)),
                new JProperty("tokensRemaining", context.Variables.GetValueOrDefault<int>("remainingTokens", 0)),
                new JProperty("timestamp", DateTime.UtcNow.ToString("o"))
            ).ToString();
        }" />
    </inbound>
    <backend>
        <forward-request />
    </backend>
    <outbound>
        <!-- Add token usage headers for client visibility -->
        <set-header name="X-Tokens-Consumed" exists-action="override">
            <value>@(context.Variables.GetValueOrDefault<int>("tokensConsumed", 0).ToString())</value>
        </set-header>
        <set-header name="X-Tokens-Remaining" exists-action="override">
            <value>@(context.Variables.GetValueOrDefault<int>("remainingTokens", 0).ToString())</value>
        </set-header>
    </outbound>
    <on-error>
        <!-- Return 429 when quota exceeded -->
        <choose>
            <when condition="@(context.Response.StatusCode == 429)">
                <return-response>
                    <set-status code="429" reason="Too Many Requests" />
                    <set-header name="Retry-After" exists-action="override">
                        <value>@(context.Variables.GetValueOrDefault<int>("retryAfter", 60).ToString())</value>
                    </set-header>
                    <set-body>@{
                        return new JObject(
                            new JProperty("error", "Token quota exceeded"),
                            new JProperty("retryAfter", context.Variables.GetValueOrDefault<int>("retryAfter", 60)),
                            new JProperty("message", "Your token quota has been exhausted. Please retry after the specified time.")
                        ).ToString();
                    }</set-body>
                </return-response>
            </when>
        </choose>
    </on-error>
</policies>
